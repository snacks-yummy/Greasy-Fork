# 新标签页Pro - 全站网页增强工具箱（Tampermonkey 脚本）

一个偏“工具箱”的用户脚本：以「新标签页打开」为核心，同时覆盖阅读增强、跳转优化、网盘提取码、CSDN 体验优化、悬浮提示、置顶/置底、已访问链接变色、调试与配置备份等能力。

## 功能概览
- 链接打开：默认新标签页打开；可切换为「仅站外链接新标签页」
- 直达 / 去重定向：智能去重定向、清理重定向参数、短链还原（可选：中转页自动跳转）
- 兼容性 / 文本链接：Discuz 论坛强制勾选新窗、动态链接监听；文本裸链转可点击链接（含白/黑名单）
- 阅读增强：自动展开内容；通用“隐藏登录弹窗遮挡”（优先适配知乎）
- 百度搜索：净化与布局（隐藏热搜/右侧、单双列、屏蔽 AI、官网置顶实验）
- CSDN：强力复制解锁、页面净化、全文居中、隐藏评论/底部推荐、解除滚动锁、中转页秒跳
- 网盘提取码：识别与合并提取码、自动填充、历史与收藏；支持快捷键触发“选区识别”
- 悬浮提示：悬浮显示网盘真实链接（优先）/ 悬浮显示完整 URL
- 便捷工具：置顶/置底按钮、复制当前页链接（中文/原始 + 快捷键）、已访问链接变色与统计
- 配置管理：设置面板搜索、导入/导出 JSON、配置操作日志；黑名单域名（命中后脚本不做任何修改）

## 安装方式
1. 安装 Tampermonkey（或兼容的用户脚本管理器）
2. 在 Tampermonkey 仪表盘中点击「添加新脚本」
3. 将 [新标签页Pro-全站网页增强工具箱.js](file:///c:/Users/Snack.Zhou/Music/8---多项目开发/1---新标签页Pro-全站网页增强工具箱/新标签页Pro-全站网页增强工具箱.js) 中的代码全部复制粘贴进去
4. 保存脚本并启用

## 使用方式
- 推荐入口：油猴菜单 →「⚙ 打开设置面板」
- 快捷开关：油猴菜单支持“精简/完整”两种展示模式，避免菜单过长
- 设置生效：设置面板点击「保存并刷新」后按新配置重载页面
- 黑名单优先：命中黑名单后，本脚本不会修改该站点任何链接或行为
- 存储方式：优先使用 GM 存储；异常时会回退到 localStorage（同样仅本地保存）

## 设置面板分组说明
- 🧩 基础：总开关、无感提示、已访问链接变色与统计
- 🚀 直达 / 去重定向：智能去重定向、清理重定向参数、中转页自动跳转、短链还原
- 🧭 打开策略：仅站外链接新标签页 + 例外（保持当前页打开）
- 🧩 兼容性 / 文本链接：Discuz/动态监听、文本裸链转链接、文本链接白/黑名单
- 📖 阅读增强：自动展开内容、隐藏登录弹窗遮挡、执行间隔与持续时长
- 💾 网盘提取码：识别/合并/自动填充、历史与收藏
- 🧷 悬浮提示：悬浮显示网盘真实链接 / 悬浮显示完整 URL
- 🔍 百度搜索：百度搜索增强与子开关（净化/布局/屏蔽 AI/官网置顶等）
- 🍃 CSDN：复制解锁、页面净化（含子菜单）、全文居中、隐藏评论/底部推荐、解除滚动锁、中转页秒跳
- ✉️ QQ邮箱：QQ邮箱去广告（VIP 气泡）
- 🧷 置顶 / 置底：右下角可拖拽滚动按钮
- 💾 设置备份：导入/导出 JSON、合并/覆盖导入、最近配置操作与日志导出
- 🐞 调试：调试悬浮窗、日志等级、跨标签同步刷新间隔
- 🚫 黑名单：黑名单域名（命中后脚本不做任何修改）

## 配置备份与同步
设置面板内提供「导入 / 导出设置（JSON）」区块：
- 导出：保存为 JSON 文件，或复制 JSON 到剪贴板
- 导入：支持从文件/剪贴板导入，并可选择“合并/覆盖”模式
- 审计：会记录“最近配置操作”，并支持导出“配置操作日志”JSON

## 油猴菜单
安装后在 Tampermonkey 菜单中可见：
- 「⚙ 打开设置面板」
- 「📋 复制当前页链接（中文/原始）」
- 「✅/❌ 复制中文URL：开启/关闭（点击切换）」
- 「⌨ 设置快捷键：复制当前页链接」
- 「✅/❌ 启用脚本：开启/关闭（点击切换）」
- 「✅/❌ 调试悬浮窗：开启/关闭（点击切换）」
- 「📋 菜单模式：精简/完整（点击切换）」
- 「✅/🚫 隐藏登录遮挡（本网站）：生效/忽略（点击切换）」
- 「🚫 添加当前域名到黑名单」
- 「🧹 清空已访问记录（全局/当前站点）」
- 「⚙ 恢复默认设置」

当菜单模式为“完整”时，会额外显示更多快速开关与工具项（如无感提示、置顶/置底、自动展开、隐藏登录遮挡（全局）、网盘能力开关、重新注入置顶/置底按钮、取消忽略当前网站（置顶/置底）等）。

## 黑名单（重要）
- 入口：设置面板 →「🚫 黑名单」或油猴菜单「🚫 添加当前域名到黑名单」
- 规则：填写 example.com 会同时匹配 sub.example.com；支持逗号/中文逗号/换行粘贴，会自动换行规范化
- 行为：命中黑名单后脚本不做任何修改（不会改链接、不会注入按钮、不会做点击拦截）

## 复制当前页链接
- 入口：油猴菜单「📋 复制当前页链接（中文/原始）」
- 控制：油猴菜单可切换「复制中文URL」，并影响“快捷键复制当前页链接”的复制内容
- 快捷键：设置面板可选组合键；若选择“自定义”，需要在油猴菜单中设置具体按键组合

## 百度搜索增强
- 生效范围：仅 www.baidu.com / m.baidu.com
- 能力：净化页面、隐藏热搜/右侧区域、单双列布局、屏蔽 AI 模块、官网置顶（实验）

## 置顶/置底按钮
- 仅在顶层页面生效（不在 iframe 中运行）
- 按钮位置可拖拽，并会记住位置
- 顶部按钮：平滑回到页面顶部；底部按钮：智能滚动到底部（兼容长页面懒加载）

## 自动展开内容（阅读增强）
- 开关位置：设置面板 →「📖 阅读增强」→「自动展开内容」
- 运行范围：仅顶层页面；并遵循“黑名单域名”
- 可调参数：执行间隔与持续时长（轮数 × 间隔）

## 调试与自检
脚本包含自检逻辑：
- `runSelfCheckOnce`：检查元数据版本号一致性
- `runThemeSyncUnitTestsOnce`：验证明暗主题配色对比度
- `runAutoUnfoldUnitTestsOnce`：覆盖自动展开的核心处理逻辑（display/height/overflow/classList/click）

遇到问题时：
1. 菜单中开启「调试悬浮窗」
2. 打开控制台，查看带有 `newtab-open-links` 前缀的日志
